<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Nginx详细教程 | 远望世界&#39; Blog</title>
<meta name="keywords" content="Nginx">
<meta name="description" content="一、Nginx介绍 1.1 引言 为什么要学习Nginx 问题1：客户端到底要将请求发送给哪台服务器 问题2：如果所有客户端的请求都发送给了服务器 问题3：">
<meta name="author" content="远望世界">
<link rel="canonical" href="https://blog.qiang.uk/2022/07/01/nginx%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.qiang.uk/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.qiang.uk/icons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.qiang.uk/icons/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.qiang.uk/icons/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.qiang.uk/icons/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://blog.qiang.uk/2022/07/01/nginx%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Nginx详细教程" />
<meta property="og:description" content="一、Nginx介绍 1.1 引言 为什么要学习Nginx 问题1：客户端到底要将请求发送给哪台服务器 问题2：如果所有客户端的请求都发送给了服务器 问题3：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.qiang.uk/2022/07/01/nginx%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" />
<meta property="og:image" content="https://blog.qiang.uk/icons/avatar.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-01T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://blog.qiang.uk/icons/avatar.png" />
<meta name="twitter:title" content="Nginx详细教程"/>
<meta name="twitter:description" content="一、Nginx介绍 1.1 引言 为什么要学习Nginx 问题1：客户端到底要将请求发送给哪台服务器 问题2：如果所有客户端的请求都发送给了服务器 问题3："/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.qiang.uk/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Nginx详细教程",
      "item": "https://blog.qiang.uk/2022/07/01/nginx%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nginx详细教程",
  "name": "Nginx详细教程",
  "description": "一、Nginx介绍 1.1 引言 为什么要学习Nginx 问题1：客户端到底要将请求发送给哪台服务器 问题2：如果所有客户端的请求都发送给了服务器 问题3：",
  "keywords": [
    "Nginx"
  ],
  "articleBody": "一、Nginx介绍 1.1 引言 为什么要学习Nginx\n问题1：客户端到底要将请求发送给哪台服务器\n问题2：如果所有客户端的请求都发送给了服务器\n问题3：客户端发送的请求可能是申请动态资源的，也有申请静态资源的\n服务器搭建集群后\n在搭建集群后，使用Nginx做反向代理\n1.2 Nginx介绍 Nginx是由俄罗斯人研发的，应对Rambler的网站并发，并且2004年发布的第一个版本\nNginx的特点\n稳定性极强，7*24小时不间断运行(就是一直运行) Nginx提供了非常丰富的配置实例 占用内存小，并发能力强（随便配置一下就是5w+，而tomcat的默认线程池是150） 二、Nginx的安装 2.1 安装Nginx 使用docker-compose安装\n#在/opt目录下创建docker_nginx目录 cd /opt mkdir docker_nginx #创建docker-compose.yml文件并编写下面的内容,保存退出 vim docker-compose.yml version: '3.1' services: nginx: restart: always image: daocloud.io/library/nginx:latest container_name: nginx ports: - 80:80 执行docker-compose up -d 2.2 Nginx的配置文件 Nginx的核心配置文件\n# 查看当前nginx的配置需要进入docker容器中 docker exec -it 容器id bash # 进入容器后 cd /etc/nginx/ cat nginx.conf nginx.conf文件内容如下\nuser nginx; worker_processes 1; error_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid; # 以上同称为全局块 # worker_processes的数值越大，Nginx的并发能力就越强 # error_log代表Nginx错误日志存放的位置 # pid是Nginx运行的一个标识 events { worker_connections 1024; } # events块 # worker_connections的数值越大，Nginx的并发能力就越强 http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; include /etc/nginx/conf.d/*.conf; } # http块 # include 代表引入一个外部文件 # include /etc/nginx/mime.types; mime.types中存放着大量媒体类型 # include /etc/nginx/conf.d/*.conf; 引入了conf.d下以.conf为结尾的配置文件 conf.d目录下只有一个default.conf文件，内容如下\nserver { listen 80; listen [::]:80; server_name localhost; #charset koi8-r; #access_log /var/log/nginx/host.access.log main; location / { root /usr/share/nginx/html; index index.html index.htm; } # location块 # root:将接受到的请求根据/usr/share/nginx/html去查找静态资源 # index:默认去上述的路径中找到index.html或index.htm } # server块 # listen代表Nginx监听的端口号 # server_name代表Nginx接受请求的IP 2.3 修改docker-compose文件 # 退出容器 exit # 关闭容器 docker-compose down # 修改docker-compose.yml文件如下 version: '3.1' services: nginx: restart: always image: daocloud.io/library/nginx:latest container_name: nginx ports: - 80:80 volumes: - /opt/docker_nginx/conf.d/:/etc/nginx/conf.d # 重新构建容器 docker-compose bulid # 重新启动容器 docker-compose up -d 这时我们再次访问80端口是访问不到的，因为我们映射了数据卷之后还没有编写server块中的内容\n接下来我们在/opt/docker_nginx/conf.d下新建default.conf，并插入如下内容\nserver { listen 80; listen [::]:80; server_name localhost; location / { root /usr/share/nginx/html; index index.html index.htm; } } # 重启nginx docker-compose restart 三、Nginx的反向代理 3.1 正向代理和反向代理介绍 正向代理：\n正向代理服务是由客户端设立的 客户端了解代理服务器和目标服务器都是谁 帮助咱们实现突破访问权限，提高访问的速度，对目标服务器隐藏客户端的ip地址 反向代理：\n反向代理服务器是配置在服务端的 客户端不知道访问的到底是哪一台服务器 达到负载均衡，并且可以隐藏服务器真正的ip地址 3.2 基于Nginx实现反向代理 准备一个目标服务器 启动tomcat服务器 编写nginx的配置文件(/opt/docker_nginx/conf.d/default.conf)，通过Nginx访问到tomcat服务器 准备Tomcat服务器\ndocker run -d -p 8080:8080 --name tomcat daocloud.io/library/tomcat:8.5.15-jre8 #或者已经下载了tomcat镜像 docker run -d -p 8080:8080 --name tomcat 镜像的标识 #添加数据卷 docker run -it -v /宿主机绝对目录:/容器内目录 镜像名 default.conf文件内容如下\nserver { listen 80; listen [::]:80; server_name localhost; # 基于反向代理访问Tomcat服务器 location / { proxy_pass http://IP:8080/; } } # 重启nginx docker-compose restart 这时我们访问80端口可以看到8080端口tomcat的默认首页\n3.3 关于Nginx的location路径映射 优先级关系： (location = ) \u003e (location /xxx/yyy/zzz) \u003e (location ^~) \u003e (location ~,~*) \u003e (location /起始路径) \u003e (location /) # 1. = 匹配 location / { # 精准匹配，主机名后面不能带能和字符串 # 例如www.baidu.com不能是www.baidu.com/id=xxx } # 2. 通用匹配 location /xxx { # 匹配所有以/xxx开头的路径 # 例如127.0.0.1:8080/xxx xxx可以为空，为空则和=匹配一样 } # 3. 正则匹配 location ~ /xxx { # 匹配所有以/xxx开头的路径 } # 4. 匹配开头路径 location ^~ /xxx/xx { # 匹配所有以/xxx/xx开头的路径 } # 5. 匹配结尾路径 location ~* \\.(gif/jpg/png)$ { # 匹配以.gif、.jpg或者.png结尾的路径 } 修改/opt/docker_nginx/conf.d/default.conf如下\nserver { listen 80; listen [::]:80; server_name localhost; location /index { proxy_pass http://IP:8081/; # A首页 } location ^~ /mall/ { proxy_pass http://IP:8080/; # B首页 } location / { proxy_pass http://IP:8080/; # C首页 } } docker-compose restart 四、Nginx负载均衡 Nginx为我们默认提供了三种负载均衡的策略：\n轮询： 将客户端发起的请求，平均分配给每一台服务器 权重： 会将客户端的请求，根据服务器的权重值不同，分配不同的数量 ip_hash: 基于发起请求的客户端的ip地址不同，他始终会将请求发送到指定的服务器上 就是说如果这个客户端的请求的ip地址不变，那么处理请求的服务器将一直是同一个 4.1 轮询 想实现轮询负载均衡机制只需要修改配置文件如下\nupstream my_server{ server IP:8080; server IP:8081; } server { listen 80; listen [::]:80; server_name localhost; location / { proxy_pass http://my_server/; #Tomcat首页 } } 4.2 权重 实现权重的方式：在配置文件中upstream块中加上weight\nupstream my_server{ server IP:8080 weight=10; server IP:8081 weight=2; } server { listen 80; listen [::]:80; server_name localhost; location / { proxy_pass http://my_server/; #Tomcat首页 } } 4.3 ip_hash 实现ip_hash方式：在配置文件upstream块中加上ip_hash\nupstream my_server{ ip_hash; server IP:8080 weight=10; server IP:8081 weight=2; } server { listen 80; listen [::]:80; server_name localhost; location / { proxy_pass http://my_server/; #Tomcat首页 } } 五、Nginx动静分离 Nginx的并发能力公式： worker_processes * worker_connections / (4 or 2)，动态资源需要/4，静态资源需要/2\nNginx通过动静分离来提升Nginx的并发能力，更快的给用户响应\n5.1 动态资源代理 # 配置如下 location / { proxy_pass 路径; } 5.2 静态资源代理 先修改docker-compose文件\nversion: '3.1' services: nginx: restart: always image: daocloud.io/library/nginx:latest container_name: nginx ports: - 80:80 volumes: - /opt/docker_nginx/conf.d/:/etc/nginx/conf.d - /opt/docker_nginx/html/:/usr/share/nginx/html # 在/opt/docker_nginx/html下新建一个index.html # 在index.html里面随便写点东西展示 # 修改nginx的配置文件 location / { root /usr/share/nginx/html; index index.html; } # 配置如下 location / { root 静态资源路径; index 默认访问路径下的什么资源; autoindex on; # 代表展示静态资源的全部内容，以列表的形式展开 } # 重启nginx docker-compose restart 六、Nginx集群 6.1 引言 目的：避免单点nginx的宕机，导致整个程序的崩溃\n准备多台nginx 准备keepalived，监听nginx的健康情况 准备haproxy，提供一个虚拟的路径，统一的去接收用户的请求 6.2 搭建 # 先准备好以下文件放入/opt/docker_nginx_cluster目录中 # 然后启动容器 注意确保80、8081和8082端口未被占用(或者修改docker-compose.yml中的端口) docker-compose up -d # 然后我们访问8081端口可以看到master，访问8082端口可以看到slave # 因为我们设置了81端口的master优先级未200比82端口的slave优先级100高，所以我们访问80端口看到的是master # 现在我们模仿8081端口的nginx宕机了 # docker stop 8081端口nginx容器的ID # 这时我们再去访问80端口看到的就是slave了 Dockerfile\nFROM nginx:1.13.5-alpine RUN apk update \u0026\u0026 apk upgrade RUN apk add --no-cache bash curl ipvsadm iproute2 openrc keepalived COPY entrypoint.sh /entrypoint.sh RUN chmod +x /entrypoint.sh CMD [\"/entrypoint.sh\"] entrypoint.sh\n#!/bin/sh #/usr/sbin/keepalvined -n -l -D -f /etc/keepalived/keepalived.conf --dont-fork --log-console \u0026 /usr/sbin/keepalvined -D -f /etc/keepalived/keepalived.conf nginx -g \"daemon off;\" docker-compose.yml\nversion: \"3.1\" services: nginx_master: build: context: ./ dockerfile: ./Dockerfile ports: -8081:80 volumes: - ./index-master.html:/usr/share/nnginx/html/index.html - ./favicon.ico:/usr/share/nnginx/html/favicon.ico - ./keepalived-master.conf:/etv/keepalived/keepalived.conf networks: static-network: ipv4_address:172.20.128.2 cap_add: - NET_ADMIN nginx_slave: build: context: ./ dockerfile: ./Dockerfile ports: -8082:80 volumes: - ./index-slave.html:/usr/share/nnginx/html/index.html - ./favicon.ico:/usr/share/nnginx/html/favicon.ico - ./keepalived-slave.conf:/etv/keepalived/keepalived.conf networks: static-network: ipv4_address:172.20.128.3 cap_add: - NET_ADMIN proxy: image: haproxy:1.7-apline ports: - 80:6301 volumes: - ./happroxy.cfg:/usr/local/etc/haproxy/haproxy.cfg networks: - static-network networks: static-network: ipam: congig: - subnet: 172.20.0.0/16 keepalived-master.conf\nvrrp_script chk_nginx { script \"pidof nginx\" interval 2 } vrrp_instance VI_1 { state MASTER interface etch0 # 容器内部的网卡名称 virtual_router_id 33 priority 200 # 优先级 advert_int 1 autheentication { auth_type PASS auth_pass letmein } virtual_ipaddress { 172.20.128.50 # 虚拟路径 } track_script { chk_nginx } } keepalived-slave.conf\nvrrp_script chk_nginx { script \"pidof nginx\" interval 2 } vrrp_instance VI_1 { state BACKUP interface etch0 # 容器内部的网卡名称 virtual_router_id 33 priority 100 # 优先级 advert_int 1 autheentication { auth_type PASS auth_pass letmein } virtual_ipaddress { 172.20.128.50 # 虚拟路径 } track_script { chk_nginx } } haproxy.cfg\nglobal log 127.0.0.1 local0 maxconn 4096 daemon nbproc 4 defaults log 127.0.0.1 local3 mode http option dontlognull option redispatch retries 2 maxconn 2000 balance roundrobin timeout connect 5000ms timeout client 5000ms timeout server 5000ms frontend main bind *:6301 default_backend webserver backend webserveer server nginx_master 127.20.127.50:80 check inter 2000 rise 2 fall 5 七、内置变量 $args #请求中的参数值 $query_string #同 $args $arg_NAME #GET请求中NAME的值 $is_args #如果请求中有参数，值为\"?\"，否则为空字符串 $uri #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如\"/foo/bar.html\"。 $document_uri #同 $uri $document_root #当前请求的文档根目录或别名 $host #优先级：HTTP请求行的主机名\u003e\"HOST\"请求头字段\u003e符合请求的服务器名.请求中的主机头字段，如果请求中的主机头不可用，则为服务器处理请求的服务器名称 $hostname #主机名 $https #如果开启了SSL安全模式，值为\"on\"，否则为空字符串。 $binary_remote_addr #客户端地址的二进制形式，固定长度为4个字节 $body_bytes_sent #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的\"%B\"参数保持兼容 $bytes_sent #传输给客户端的字节数 $connection #TCP连接的序列号 $connection_requests #TCP连接当前的请求数量 $content_length #\"Content-Length\" 请求头字段 $content_type #\"Content-Type\" 请求头字段 $cookie_name #cookie名称 $limit_rate #用于设置响应的速度限制 $msec #当前的Unix时间戳 $nginx_version #nginx版本 $pid #工作进程的PID $pipe #如果请求来自管道通信，值为\"p\"，否则为\".\" $proxy_protocol_addr #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串 $realpath_root #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径 $remote_addr #客户端地址 $remote_port #客户端端口 $remote_user #用于HTTP基础认证服务的用户名 $request #代表客户端的请求地址 $request_body #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器 $request_body_file #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传 递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off $request_completion #如果请求成功，值为\"OK\"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空 $request_filename #当前连接请求的文件路径，由root或alias指令与URI请求生成 $request_length #请求的长度 (包括请求的地址，http请求头和请求主体) $request_method #HTTP请求方法，通常为\"GET\"或\"POST\" $request_time #处理客户端请求使用的时间,单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。 $request_uri #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：\"/cnphp/test.php?arg=freemouse\" $scheme #请求使用的Web协议，\"http\" 或 \"https\" $server_addr #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中 $server_name #服务器名 $server_port #服务器端口 $server_protocol #服务器的HTTP版本，通常为 \"HTTP/1.0\" 或 \"HTTP/1.1\" $status #HTTP响应代码 $time_iso8601 #服务器时间的ISO 8610格式 $time_local #服务器时间（LOG Format 格式） $cookie_NAME #客户端请求Header头中的cookie变量，前缀\"$cookie_\"加上cookie名称的变量，该变量的值即为cookie名称的值 $http_NAME #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：\"Accept-Language\"，$http_accept_language即可 $http_cookie $http_host #请求地址，即浏览器中你输入的地址（IP或域名） $http_referer #url跳转来源,用来记录从那个页面链接访问过来的 $http_user_agent #用户终端浏览器等信息 $http_x_forwarded_for $sent_http_NAME #可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可 $sent_http_cache_control $sent_http_connection $sent_http_content_type $sent_http_keep_alive $sent_http_last_modified $sent_http_location $sent_http_transfer_encoding ",
  "wordCount" : "5056",
  "inLanguage": "zh",
  "image": "https://blog.qiang.uk/icons/avatar.png","datePublished": "2022-07-01T00:00:00Z",
  "dateModified": "2022-07-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "远望世界"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.qiang.uk/2022/07/01/nginx%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "远望世界' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.qiang.uk/icons/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.qiang.uk/" accesskey="h" title="远望世界&#39; Blog (Alt + H)">远望世界&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.qiang.uk/posts" title="主页">
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="https://blog.qiang.uk/search" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.qiang.uk/categories" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://blog.qiang.uk/tags" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.qiang.uk/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://memo.qiang.uk/" title="随记">
                    <span>随记</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.qiang.uk/">主页</a>&nbsp;»&nbsp;<a href="https://blog.qiang.uk/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Nginx详细教程
    </h1>
    <div class="post-meta"><span title='2022-07-01 00:00:00 +0000 UTC'>七月 1, 2022</span>&nbsp;·&nbsp;11 分钟&nbsp;·&nbsp;远望世界&nbsp;|&nbsp;<a href="https://github.com/yuanwangshijie/hugo-blog/tree/main/content/posts/2022/Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b.md" rel="noopener noreferrer" target="_blank">编辑此页</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%80nginx%e4%bb%8b%e7%bb%8d" aria-label="一、Nginx介绍">一、Nginx介绍</a><ul>
                        
                <li>
                    <a href="#11-%e5%bc%95%e8%a8%80" aria-label="1.1 引言">1.1 引言</a></li>
                <li>
                    <a href="#12-nginx%e4%bb%8b%e7%bb%8d" aria-label="1.2 Nginx介绍">1.2 Nginx介绍</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8cnginx%e7%9a%84%e5%ae%89%e8%a3%85" aria-label="二、Nginx的安装">二、Nginx的安装</a><ul>
                        
                <li>
                    <a href="#21-%e5%ae%89%e8%a3%85nginx" aria-label="2.1 安装Nginx">2.1 安装Nginx</a></li>
                <li>
                    <a href="#22-nginx%e7%9a%84%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="2.2 Nginx的配置文件">2.2 Nginx的配置文件</a></li>
                <li>
                    <a href="#23-%e4%bf%ae%e6%94%b9docker-compose%e6%96%87%e4%bb%b6" aria-label="2.3 修改docker-compose文件">2.3 修改docker-compose文件</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%89nginx%e7%9a%84%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" aria-label="三、Nginx的反向代理">三、Nginx的反向代理</a><ul>
                        
                <li>
                    <a href="#31-%e6%ad%a3%e5%90%91%e4%bb%a3%e7%90%86%e5%92%8c%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e4%bb%8b%e7%bb%8d" aria-label="3.1 正向代理和反向代理介绍">3.1 正向代理和反向代理介绍</a></li>
                <li>
                    <a href="#32-%e5%9f%ba%e4%ba%8enginx%e5%ae%9e%e7%8e%b0%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" aria-label="3.2 基于Nginx实现反向代理">3.2 基于Nginx实现反向代理</a></li>
                <li>
                    <a href="#33-%e5%85%b3%e4%ba%8enginx%e7%9a%84location%e8%b7%af%e5%be%84%e6%98%a0%e5%b0%84" aria-label="3.3 关于Nginx的location路径映射">3.3 关于Nginx的location路径映射</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9bnginx%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="四、Nginx负载均衡">四、Nginx负载均衡</a><ul>
                        
                <li>
                    <a href="#41-%e8%bd%ae%e8%af%a2" aria-label="4.1 轮询">4.1 轮询</a></li>
                <li>
                    <a href="#42-%e6%9d%83%e9%87%8d" aria-label="4.2 权重">4.2 权重</a></li>
                <li>
                    <a href="#43-ip_hash" aria-label="4.3 ip_hash">4.3 ip_hash</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%94nginx%e5%8a%a8%e9%9d%99%e5%88%86%e7%a6%bb" aria-label="五、Nginx动静分离">五、Nginx动静分离</a><ul>
                        
                <li>
                    <a href="#51-%e5%8a%a8%e6%80%81%e8%b5%84%e6%ba%90%e4%bb%a3%e7%90%86" aria-label="5.1 动态资源代理">5.1 动态资源代理</a></li>
                <li>
                    <a href="#52-%e9%9d%99%e6%80%81%e8%b5%84%e6%ba%90%e4%bb%a3%e7%90%86" aria-label="5.2 静态资源代理">5.2 静态资源代理</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%adnginx%e9%9b%86%e7%be%a4" aria-label="六、Nginx集群">六、Nginx集群</a><ul>
                        
                <li>
                    <a href="#61-%e5%bc%95%e8%a8%80" aria-label="6.1 引言">6.1 引言</a></li>
                <li>
                    <a href="#62-%e6%90%ad%e5%bb%ba" aria-label="6.2 搭建">6.2 搭建</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%83%e5%86%85%e7%bd%ae%e5%8f%98%e9%87%8f" aria-label="七、内置变量">七、内置变量</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="一nginx介绍">一、Nginx介绍<a hidden class="anchor" aria-hidden="true" href="#一nginx介绍">#</a></h2>
<h3 id="11-引言">1.1 引言<a hidden class="anchor" aria-hidden="true" href="#11-引言">#</a></h3>
<blockquote>
<p>为什么要学习<code>Nginx</code><br>
问题1：客户端到底要将请求发送给哪台服务器<br>
问题2：如果所有客户端的请求都发送给了服务器<br>
问题3：客户端发送的请求可能是申请动态资源的，也有申请静态资源的<br></p>
</blockquote>
<p><strong>服务器搭建集群后</strong></p>
<p><img loading="lazy" src="https://minio.qiang.uk/static/2023/05/15/7179424959c8ad4167cf68d69bbd4ea5.png" alt=""  />
</p>
<p><strong>在搭建集群后，使用Nginx做反向代理</strong></p>
<p><img loading="lazy" src="https://minio.qiang.uk/static/2023/05/15/117f0fde1b4510eb26482d28f197cd58.png" alt=""  />
</p>
<h3 id="12-nginx介绍">1.2 Nginx介绍<a hidden class="anchor" aria-hidden="true" href="#12-nginx介绍">#</a></h3>
<p><code>Nginx</code>是由俄罗斯人研发的，应对<code>Rambler</code>的网站并发，并且2004年发布的第一个版本</p>
<blockquote>
<p><strong>Nginx的特点</strong></p>
<ol>
<li>稳定性极强，7*24小时不间断运行(就是一直运行)</li>
<li>Nginx提供了非常丰富的配置实例</li>
<li>占用内存小，并发能力强（随便配置一下就是5w+，而tomcat的默认线程池是150）</li>
</ol>
</blockquote>
<h2 id="二nginx的安装">二、Nginx的安装<a hidden class="anchor" aria-hidden="true" href="#二nginx的安装">#</a></h2>
<h3 id="21-安装nginx">2.1 安装Nginx<a hidden class="anchor" aria-hidden="true" href="#21-安装nginx">#</a></h3>
<p>使用<code>docker-compose</code>安装</p>
<pre tabindex="0"><code>#在/opt目录下创建docker_nginx目录
cd /opt
mkdir docker_nginx
#创建docker-compose.yml文件并编写下面的内容,保存退出
vim docker-compose.yml
</code></pre><pre tabindex="0"><code>version: &#39;3.1&#39;
services: 
  nginx:
    restart: always
    image: daocloud.io/library/nginx:latest
    container_name: nginx
    ports: 
      - 80:80
</code></pre><pre tabindex="0"><code>执行docker-compose up -d
</code></pre><h3 id="22-nginx的配置文件">2.2 Nginx的配置文件<a hidden class="anchor" aria-hidden="true" href="#22-nginx的配置文件">#</a></h3>
<p><code>Nginx</code>的核心配置文件</p>
<pre tabindex="0"><code># 查看当前nginx的配置需要进入docker容器中
docker exec -it 容器id bash
# 进入容器后
cd /etc/nginx/
cat nginx.conf
</code></pre><p><code>nginx.conf</code>文件内容如下</p>
<pre tabindex="0"><code>user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
# 以上同称为全局块
# worker_processes的数值越大，Nginx的并发能力就越强
# error_log代表Nginx错误日志存放的位置
# pid是Nginx运行的一个标识

events {
    worker_connections  1024;
}
# events块
# worker_connections的数值越大，Nginx的并发能力就越强

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

# http块
# include 代表引入一个外部文件
# include /etc/nginx/mime.types;    mime.types中存放着大量媒体类型
# include /etc/nginx/conf.d/*.conf; 引入了conf.d下以.conf为结尾的配置文件
</code></pre><p><code>conf.d</code>目录下只有一个<code>default.conf</code>文件，内容如下</p>
<pre tabindex="0"><code>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
    # location块
    # root:将接受到的请求根据/usr/share/nginx/html去查找静态资源
    # index:默认去上述的路径中找到index.html或index.htm

}

# server块
# listen代表Nginx监听的端口号
# server_name代表Nginx接受请求的IP
</code></pre><h3 id="23-修改docker-compose文件">2.3 修改docker-compose文件<a hidden class="anchor" aria-hidden="true" href="#23-修改docker-compose文件">#</a></h3>
<pre tabindex="0"><code># 退出容器
exit
# 关闭容器
docker-compose down
# 修改docker-compose.yml文件如下
</code></pre><pre tabindex="0"><code>version: &#39;3.1&#39;
services: 
  nginx:
    restart: always
    image: daocloud.io/library/nginx:latest
    container_name: nginx
    ports: 
      - 80:80
    volumes:
      - /opt/docker_nginx/conf.d/:/etc/nginx/conf.d
</code></pre><pre tabindex="0"><code># 重新构建容器
docker-compose bulid
# 重新启动容器
docker-compose up -d
</code></pre><p>这时我们再次访问<code>80</code>端口是访问不到的，因为我们映射了数据卷之后还没有编写<code>server</code>块中的内容</p>
<p>接下来我们在<code>/opt/docker_nginx/conf.d</code>下新建<code>default.conf</code>，并插入如下内容</p>
<pre tabindex="0"><code>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
}
</code></pre><pre tabindex="0"><code># 重启nginx
docker-compose restart
</code></pre><h2 id="三nginx的反向代理">三、Nginx的反向代理<a hidden class="anchor" aria-hidden="true" href="#三nginx的反向代理">#</a></h2>
<h3 id="31-正向代理和反向代理介绍">3.1 正向代理和反向代理介绍<a hidden class="anchor" aria-hidden="true" href="#31-正向代理和反向代理介绍">#</a></h3>
<blockquote>
<p>正向代理：</p>
<ol>
<li>正向代理服务是由客户端设立的</li>
<li>客户端了解代理服务器和目标服务器都是谁</li>
<li>帮助咱们实现突破访问权限，提高访问的速度，对目标服务器隐藏客户端的ip地址</li>
</ol>
</blockquote>
<p><img loading="lazy" src="https://minio.qiang.uk/static/2023/05/15/6345c4de022284687b194f721190746e.png" alt=""  />
</p>
<blockquote>
<p>反向代理：</p>
<ol>
<li>反向代理服务器是配置在服务端的</li>
<li>客户端不知道访问的到底是哪一台服务器</li>
<li>达到负载均衡，并且可以隐藏服务器真正的ip地址</li>
</ol>
</blockquote>
<p><img loading="lazy" src="https://minio.qiang.uk/static/2023/05/15/21117a693cfa213840e7e732a134ce54.png" alt=""  />
</p>
<h3 id="32-基于nginx实现反向代理">3.2 基于Nginx实现反向代理<a hidden class="anchor" aria-hidden="true" href="#32-基于nginx实现反向代理">#</a></h3>
<blockquote>
<ol>
<li>准备一个目标服务器</li>
<li>启动tomcat服务器</li>
<li>编写nginx的配置文件(/opt/docker_nginx/conf.d/default.conf)，通过Nginx访问到tomcat服务器</li>
</ol>
</blockquote>
<p>准备<code>Tomcat</code>服务器</p>
<pre tabindex="0"><code>docker run -d -p 8080:8080 --name tomcat  daocloud.io/library/tomcat:8.5.15-jre8
#或者已经下载了tomcat镜像
docker run -d -p 8080:8080 --name tomcat 镜像的标识
#添加数据卷
docker run -it -v /宿主机绝对目录:/容器内目录 镜像名
</code></pre><p><code>default.conf</code>文件内容如下</p>
<pre tabindex="0"><code>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;
    # 基于反向代理访问Tomcat服务器
    location / {
        proxy_pass http://IP:8080/;
    }
}
</code></pre><pre tabindex="0"><code># 重启nginx 
docker-compose restart
</code></pre><p>这时我们访问<code>80</code>端口可以看到<code>8080</code>端口tomcat的默认首页</p>
<h3 id="33-关于nginx的location路径映射">3.3 关于Nginx的location路径映射<a hidden class="anchor" aria-hidden="true" href="#33-关于nginx的location路径映射">#</a></h3>
<pre tabindex="0"><code>优先级关系：
(location = ) 
    &gt; (location /xxx/yyy/zzz) 
    &gt; (location ^~) 
    &gt; (location ~,~*) 
    &gt; (location /起始路径) 
    &gt; (location /)
</code></pre><pre tabindex="0"><code># 1. = 匹配
location / {
    # 精准匹配，主机名后面不能带能和字符串
    # 例如www.baidu.com不能是www.baidu.com/id=xxx
}
</code></pre><pre tabindex="0"><code># 2. 通用匹配
location /xxx {
    # 匹配所有以/xxx开头的路径
    # 例如127.0.0.1:8080/xxx  xxx可以为空，为空则和=匹配一样
}
</code></pre><pre tabindex="0"><code># 3. 正则匹配
location ~ /xxx {
    # 匹配所有以/xxx开头的路径
}
</code></pre><pre tabindex="0"><code># 4. 匹配开头路径
location ^~ /xxx/xx {
    # 匹配所有以/xxx/xx开头的路径
}
</code></pre><pre tabindex="0"><code># 5. 匹配结尾路径
location ~* \.(gif/jpg/png)$ {
    # 匹配以.gif、.jpg或者.png结尾的路径
}
</code></pre><p>修改<code>/opt/docker_nginx/conf.d/default.conf</code>如下</p>
<pre tabindex="0"><code>server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location /index {
        proxy_pass http://IP:8081/; # A首页
    }

    location ^~ /mall/ {
        proxy_pass http://IP:8080/; # B首页
    }

    location / {
        proxy_pass http://IP:8080/; # C首页
    }
}
</code></pre><pre tabindex="0"><code>docker-compose restart
</code></pre><h2 id="四nginx负载均衡">四、Nginx负载均衡<a hidden class="anchor" aria-hidden="true" href="#四nginx负载均衡">#</a></h2>
<blockquote>
<p>Nginx为我们默认提供了三种负载均衡的策略：</p>
<ol>
<li>轮询： 将客户端发起的请求，平均分配给每一台服务器</li>
<li>权重： 会将客户端的请求，根据服务器的权重值不同，分配不同的数量</li>
<li>ip_hash: 基于发起请求的客户端的ip地址不同，他始终会将请求发送到指定的服务器上 就是说如果这个客户端的请求的ip地址不变，那么处理请求的服务器将一直是同一个</li>
</ol>
</blockquote>
<h3 id="41-轮询">4.1 轮询<a hidden class="anchor" aria-hidden="true" href="#41-轮询">#</a></h3>
<p>想实现<code>轮询</code>负载均衡机制只需要修改配置文件如下</p>
<pre tabindex="0"><code>upstream my_server{
    server IP:8080;
    server IP:8081;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        proxy_pass http://my_server/;   #Tomcat首页
    }
}
</code></pre><h3 id="42-权重">4.2 权重<a hidden class="anchor" aria-hidden="true" href="#42-权重">#</a></h3>
<p>实现<code>权重</code>的方式：在配置文件中<code>upstream</code>块中加上<code>weight</code></p>
<pre tabindex="0"><code>upstream my_server{
    server IP:8080 weight=10;
    server IP:8081 weight=2;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        proxy_pass http://my_server/;   #Tomcat首页
    }
}
</code></pre><h3 id="43-ip_hash">4.3 ip_hash<a hidden class="anchor" aria-hidden="true" href="#43-ip_hash">#</a></h3>
<p>实现<code>ip_hash</code>方式：在配置文件<code>upstream</code>块中加上<code>ip_hash</code></p>
<pre tabindex="0"><code>upstream my_server{
    ip_hash;
    server IP:8080 weight=10;
    server IP:8081 weight=2;
}
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        proxy_pass http://my_server/;   #Tomcat首页
    }
}
</code></pre><h2 id="五nginx动静分离">五、Nginx动静分离<a hidden class="anchor" aria-hidden="true" href="#五nginx动静分离">#</a></h2>
<blockquote>
<p>Nginx的并发能力公式： <code>worker_processes</code> * <code>worker_connections</code> / (4 or 2)，动态资源需要/4，静态资源需要/2<br>
Nginx通过动静分离来提升Nginx的并发能力，更快的给用户响应</p>
</blockquote>
<h3 id="51-动态资源代理">5.1 动态资源代理<a hidden class="anchor" aria-hidden="true" href="#51-动态资源代理">#</a></h3>
<pre tabindex="0"><code># 配置如下
location / {
  proxy_pass 路径;
}
</code></pre><h3 id="52-静态资源代理">5.2 静态资源代理<a hidden class="anchor" aria-hidden="true" href="#52-静态资源代理">#</a></h3>
<p>先修改<code>docker-compose</code>文件</p>
<pre tabindex="0"><code>version: &#39;3.1&#39;
services: 
  nginx:
    restart: always
    image: daocloud.io/library/nginx:latest
    container_name: nginx
    ports: 
      - 80:80
    volumes:
      - /opt/docker_nginx/conf.d/:/etc/nginx/conf.d
      - /opt/docker_nginx/html/:/usr/share/nginx/html
</code></pre><pre tabindex="0"><code># 在/opt/docker_nginx/html下新建一个index.html
# 在index.html里面随便写点东西展示
# 修改nginx的配置文件

location / {
    root /usr/share/nginx/html;
    index index.html;
}
</code></pre><pre tabindex="0"><code># 配置如下
location / {
    root 静态资源路径;
    index 默认访问路径下的什么资源;
    autoindex on; # 代表展示静态资源的全部内容，以列表的形式展开
}
</code></pre><pre tabindex="0"><code># 重启nginx
docker-compose restart
</code></pre><h2 id="六nginx集群">六、Nginx集群<a hidden class="anchor" aria-hidden="true" href="#六nginx集群">#</a></h2>
<h3 id="61-引言">6.1 引言<a hidden class="anchor" aria-hidden="true" href="#61-引言">#</a></h3>
<blockquote>
<p>目的：避免单点nginx的宕机，导致整个程序的崩溃</p>
<ul>
<li>准备多台nginx</li>
<li>准备keepalived，监听nginx的健康情况</li>
<li>准备haproxy，提供一个虚拟的路径，统一的去接收用户的请求</li>
</ul>
</blockquote>
<p><img loading="lazy" src="https://minio.qiang.uk/static/2023/05/15/c06f3f566b0fa3ced92316763989e951.png" alt=""  />
</p>
<h3 id="62-搭建">6.2 搭建<a hidden class="anchor" aria-hidden="true" href="#62-搭建">#</a></h3>
<pre tabindex="0"><code># 先准备好以下文件放入/opt/docker_nginx_cluster目录中
# 然后启动容器    注意确保80、8081和8082端口未被占用(或者修改docker-compose.yml中的端口)
docker-compose up -d

# 然后我们访问8081端口可以看到master，访问8082端口可以看到slave
# 因为我们设置了81端口的master优先级未200比82端口的slave优先级100高，所以我们访问80端口看到的是master
# 现在我们模仿8081端口的nginx宕机了
# docker stop 8081端口nginx容器的ID
# 这时我们再去访问80端口看到的就是slave了
</code></pre><p><code>Dockerfile</code></p>
<pre tabindex="0"><code>FROM nginx:1.13.5-alpine
RUN apk update &amp;&amp; apk upgrade
RUN apk add --no-cache bash curl ipvsadm iproute2 openrc keepalived
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
CMD [&#34;/entrypoint.sh&#34;]
</code></pre><p><code>entrypoint.sh</code></p>
<pre tabindex="0"><code>#!/bin/sh

#/usr/sbin/keepalvined -n -l -D -f /etc/keepalived/keepalived.conf --dont-fork --log-console &amp;
/usr/sbin/keepalvined -D -f /etc/keepalived/keepalived.conf

nginx -g &#34;daemon off;&#34;
</code></pre><p><code>docker-compose.yml</code></p>
<pre tabindex="0"><code>version: &#34;3.1&#34;
services:
  nginx_master:
    build:
      context: ./
      dockerfile: ./Dockerfile
    ports:
      -8081:80
    volumes:
      - ./index-master.html:/usr/share/nnginx/html/index.html
      - ./favicon.ico:/usr/share/nnginx/html/favicon.ico
      - ./keepalived-master.conf:/etv/keepalived/keepalived.conf
    networks:
      static-network:
        ipv4_address:172.20.128.2
    cap_add:
      - NET_ADMIN
  nginx_slave:
    build:
      context: ./
      dockerfile: ./Dockerfile
    ports:
      -8082:80
    volumes:
      - ./index-slave.html:/usr/share/nnginx/html/index.html
      - ./favicon.ico:/usr/share/nnginx/html/favicon.ico
      - ./keepalived-slave.conf:/etv/keepalived/keepalived.conf
    networks:
      static-network:
        ipv4_address:172.20.128.3
    cap_add:
      - NET_ADMIN
  proxy:
    image:  haproxy:1.7-apline
    ports:
      - 80:6301
    volumes:
      - ./happroxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    networks:
      - static-network
networks:
  static-network:
    ipam:
      congig:
        - subnet: 172.20.0.0/16
</code></pre><p><code>keepalived-master.conf</code></p>
<pre tabindex="0"><code>vrrp_script chk_nginx {
    script &#34;pidof nginx&#34;
    interval 2
}

vrrp_instance VI_1 {
    state MASTER
    interface etch0 # 容器内部的网卡名称
    virtual_router_id 33
    priority 200    # 优先级
    advert_int 1
    
    autheentication {
        auth_type PASS
        auth_pass letmein
    }

    virtual_ipaddress {
        172.20.128.50   # 虚拟路径
    }

    track_script {
        chk_nginx
    }
}
</code></pre><p><code>keepalived-slave.conf</code></p>
<pre tabindex="0"><code>vrrp_script chk_nginx {
    script &#34;pidof nginx&#34;
    interval 2
}

vrrp_instance VI_1 {
    state BACKUP
    interface etch0 # 容器内部的网卡名称
    virtual_router_id 33
    priority 100    # 优先级
    advert_int 1
    
    autheentication {
        auth_type PASS
        auth_pass letmein
    }

    virtual_ipaddress {
        172.20.128.50   # 虚拟路径
    }

    track_script {
        chk_nginx
    }
}
</code></pre><p><code>haproxy.cfg</code></p>
<pre tabindex="0"><code>global
    log 127.0.0.1 local0
    maxconn 4096
    daemon
    nbproc 4
    
defaults
    log 127.0.0.1 local3
    mode http
    option dontlognull
    option redispatch
    retries 2
    maxconn 2000
    balance roundrobin
    timeout connect 5000ms
    timeout client 5000ms
    timeout server 5000ms
    
frontend main
    bind *:6301
    default_backend webserver
    
backend webserveer
    server nginx_master 127.20.127.50:80 check inter 2000 rise 2 fall 5
</code></pre><h2 id="七内置变量">七、内置变量<a hidden class="anchor" aria-hidden="true" href="#七内置变量">#</a></h2>
<pre tabindex="0"><code>$args                    #请求中的参数值
$query_string            #同 $args
$arg_NAME                #GET请求中NAME的值
$is_args                 #如果请求中有参数，值为&#34;?&#34;，否则为空字符串
$uri                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如&#34;/foo/bar.html&#34;。
$document_uri            #同 $uri
$document_root           #当前请求的文档根目录或别名
$host                    #优先级：HTTP请求行的主机名&gt;&#34;HOST&#34;请求头字段&gt;符合请求的服务器名.请求中的主机头字段，如果请求中的主机头不可用，则为服务器处理请求的服务器名称
$hostname                #主机名
$https                   #如果开启了SSL安全模式，值为&#34;on&#34;，否则为空字符串。
$binary_remote_addr      #客户端地址的二进制形式，固定长度为4个字节
$body_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的&#34;%B&#34;参数保持兼容
$bytes_sent              #传输给客户端的字节数
$connection              #TCP连接的序列号
$connection_requests     #TCP连接当前的请求数量
$content_length          #&#34;Content-Length&#34; 请求头字段
$content_type            #&#34;Content-Type&#34; 请求头字段
$cookie_name             #cookie名称
$limit_rate              #用于设置响应的速度限制
$msec                    #当前的Unix时间戳
$nginx_version           #nginx版本
$pid                     #工作进程的PID
$pipe                    #如果请求来自管道通信，值为&#34;p&#34;，否则为&#34;.&#34;
$proxy_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串
$realpath_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径
$remote_addr             #客户端地址
$remote_port             #客户端端口
$remote_user             #用于HTTP基础认证服务的用户名
$request                 #代表客户端的请求地址
$request_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器
$request_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传 递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off
$request_completion      #如果请求成功，值为&#34;OK&#34;，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空
$request_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成
$request_length          #请求的长度 (包括请求的地址，http请求头和请求主体)
$request_method          #HTTP请求方法，通常为&#34;GET&#34;或&#34;POST&#34;
$request_time            #处理客户端请求使用的时间,单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。
$request_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：&#34;/cnphp/test.php?arg=freemouse&#34;
$scheme                  #请求使用的Web协议，&#34;http&#34; 或 &#34;https&#34;
$server_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中
$server_name             #服务器名
$server_port             #服务器端口
$server_protocol         #服务器的HTTP版本，通常为 &#34;HTTP/1.0&#34; 或 &#34;HTTP/1.1&#34;
$status                  #HTTP响应代码
$time_iso8601            #服务器时间的ISO 8610格式
$time_local              #服务器时间（LOG Format 格式）
$cookie_NAME             #客户端请求Header头中的cookie变量，前缀&#34;$cookie_&#34;加上cookie名称的变量，该变量的值即为cookie名称的值
$http_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：&#34;Accept-Language&#34;，$http_accept_language即可
$http_cookie
$http_host               #请求地址，即浏览器中你输入的地址（IP或域名）
$http_referer            #url跳转来源,用来记录从那个页面链接访问过来的
$http_user_agent         #用户终端浏览器等信息
$http_x_forwarded_for
$sent_http_NAME          #可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可
$sent_http_cache_control
$sent_http_connection
$sent_http_content_type
$sent_http_keep_alive
$sent_http_last_modified
$sent_http_location
$sent_http_transfer_encoding
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.qiang.uk/tags/nginx/">Nginx</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.qiang.uk/2022/12/26/%E9%9A%8F%E6%9C%BA%E5%9B%BE%E7%89%87api/">
    <span class="title">« 上一页</span>
    <br>
    <span>随机图片api</span>
  </a>
  <a class="next" href="https://blog.qiang.uk/2022/06/01/mybatisplus%E6%9D%A1%E4%BB%B6%E6%9E%84%E9%80%A0%E5%99%A8/">
    <span class="title">下一页 »</span>
    <br>
    <span>MybatisPlus条件构造器</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on x"
            href="https://x.com/intent/tweet/?text=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b&amp;url=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f&amp;hashtags=Nginx">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f&amp;title=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b&amp;summary=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b&amp;source=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f&title=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on whatsapp"
            href="https://api.whatsapp.com/send?text=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b%20-%20https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on telegram"
            href="https://telegram.me/share/url?text=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b&amp;url=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Nginx详细教程 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Nginx%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b&u=https%3a%2f%2fblog.qiang.uk%2f2022%2f07%2f01%2fnginx%25E8%25AF%25A6%25E7%25BB%2586%25E6%2595%2599%25E7%25A8%258B%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://blog.qiang.uk/">远望世界</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
